#!/bin/bash

source /data/src/docker/joynr-base/scripts/start-and-stop-gcd-service.sh
export CHROME_BIN=/usr/bin/chromium-browser
source /data/src/docker/joynr-base/scripts/global.sh

cd /data/src

# fail on first error
# exit immediately if a command exits with a non-zero status
# print commands before they are executed
set -e

function usage
{
  echo "usage: javascript-clean-build [--skipTests]"
}

SKIPTESTS='false'

while [ "$1" != "" ]; do
  case $1 in
    --skipTests )           SKIPTESTS='true'
                            ;;
    * )                     usage
                            exit 1
  esac
  shift
done

(
  log "INSTALL JOYNR BASE MODEL, TOOLS AND INFRASTRUCTURE SERVICES"
  mvn clean install -P no-license-and-notice,no-java-formatter,no-checkstyle -DskipTests
)


if [ "$SKIPTESTS" == "false" ]
then
    echo '####################################################'
    echo '# start services'
    echo '####################################################'

    /data/src/docker/joynr-base/scripts/start-db.sh

    mosquitto -c /data/src/docker/joynr-base/mosquitto.conf &
    MOSQUITTO_PID=$!

    startGcd
fi

(
  echo "building joynr JavaScript API"
  cd javascript
  mvn clean install \
  -Dskip.copy-notice-file=true \
  -Dskip.unpack-license-info=true \
  -DskipTests=$SKIPTESTS

  echo "building joynr npm generator"
  cd ../tools/generator/joynr-generator-npm
  mvn clean install
)

if [ "$SKIPTESTS" == "false" ]
then
    echo '####################################################'
    echo '# stop services'
    echo '####################################################'

    stopGcd
    kill -TERM $MOSQUITTO_PID
    wait $MOSQUITTO_PID
    /data/src/docker/joynr-base/scripts/stop-db.sh
fi

