<?xml version="1.0" encoding="UTF-8"?>
<!--
  #%L
  %%
  Copyright (C) 2011 - 2017 BMW Car IT GmbH
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<artifactId>libjoynr-js</artifactId>
	<groupId>io.joynr.javascript</groupId>
	<packaging>jar</packaging>
	<name>${project.groupId}:${project.artifactId}</name>
	<description>JOYnr JavaScript libjoynr-js</description>

	<parent>
		<groupId>io.joynr</groupId>
		<artifactId>javascript</artifactId>
		<version>0.31.0-SNAPSHOT</version>
	</parent>

	<properties>
		<atmosphere.javascript.version>2.0.9</atmosphere.javascript.version>
		<bluebird.version>3.1.1</bluebird.version>
		<text-encoding.version>0.6.4</text-encoding.version>
		<log4javascript.version>1.4.10</log4javascript.version>
		<jetty.version>9.2.13.v20150730</jetty.version>
		<mqtt.version>2.0.1</mqtt.version>
		<netbeans.hint.deploy.server>gfv3ee6</netbeans.hint.deploy.server>
		<project.build.optimizerResources>${project.build.directory}/build-resources/almond</project.build.optimizerResources>
		<joynr.provisioning.brokerUri>tcp://127.0.0.1:9001</joynr.provisioning.brokerUri>
		<joynr.provisioning.bounceProxyBaseUrl>http://127.0.0.1:8080</joynr.provisioning.bounceProxyBaseUrl>
		<joynr.provisioning.testTtl>10000</joynr.provisioning.testTtl>
	</properties>

	<dependencies>
		<dependency>
			<groupId>io.joynr.javascript</groupId>
			<artifactId>js-dependencies</artifactId>
			<version>${project.version}</version>
		</dependency>
		<dependency>
			<groupId>io.joynr</groupId>
			<artifactId>basemodel</artifactId>
			<version>${project.version}</version>
			<type>test-jar</type>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<build>
		<sourceDirectory>src/main/js</sourceDirectory>
		<resources>
			<resource>
				<directory>src/main/js</directory>
			</resource>
			<resource>
				<directory>src/main/resources</directory>
				<filtering>true</filtering>
			</resource>
			<resource>
				<directory>src/main/generated</directory>
			</resource>
		</resources>

		<testSourceDirectory>src/test/js</testSourceDirectory>
		<testResources>
			<testResource>
				<directory>src/test/resources</directory>
				<filtering>true</filtering>
			</testResource>
			<testResource>
				<directory>src/test/karma</directory>
				<filtering>true</filtering>
			</testResource>
			<!-- the source folder must be copied as resource since otherwise only
				java files would be copied -->
			<testResource>
				<directory>src/test/js</directory>
				<filtering>true</filtering>
			</testResource>
			<testResource>
				<directory>src/test/generated</directory>
			</testResource>
		</testResources>

		<plugins>

			<plugin>
				<groupId>org.codehaus.mojo</groupId>
				<artifactId>build-helper-maven-plugin</artifactId>
				<executions>
					<execution>
						<phase>generate-sources</phase>
						<goals>
							<goal>add-source</goal>
						</goals>
						<configuration>
							<sources>
								<source>src/main/generated</source>
							</sources>
						</configuration>
					</execution>
				</executions>
			</plugin>

			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-clean-plugin</artifactId>
				<configuration>
					<filesets>
						<fileset>
							<directory>src/main/generated</directory>
							<includes>
								<include>**</include>
							</includes>
						</fileset>
						<fileset>
							<directory>src/test/generated</directory>
							<includes>
								<include>**</include>
							</includes>
						</fileset>
					</filesets>
				</configuration>
			</plugin>

			<plugin>
				<groupId>io.joynr.tools.generator</groupId>
				<artifactId>joynr-generator-maven-plugin</artifactId>
				<configuration>
					<generationLanguage>javascript</generationLanguage>
					<parameter>
						<requiredModule>joynr</requiredModule>
						<anonymuousDefine>false</anonymuousDefine>
					</parameter>
				</configuration>
				<executions>
					<execution>
						<id>discovery-types</id>
						<phase>generate-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>joynr/DiscoveryTypes.fidl</model>
							<outputPath>${basedir}/src/main/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>discovery</id>
						<phase>generate-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>joynr/Discovery.fidl</model>
							<outputPath>${basedir}/src/main/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>routing</id>
						<phase>generate-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>joynr/Routing.fidl</model>
							<outputPath>${basedir}/src/main/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>capabilitiesDirectory</id>
						<phase>generate-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>joynr/GlobalCapabilitiesDirectory.fidl</model>
							<outputPath>${basedir}/src/main/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>distributedLogging</id>
						<phase>generate-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>system/LoggingService.fidl</model>
							<outputPath>${basedir}/src/main/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>types</id>
						<phase>generate-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>common/Types.fidl</model>
							<outputPath>${basedir}/src/main/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>datatypesProxyAndProvider</id>
						<phase>generate-test-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<!-- parameter>
								<requiredModule>joynr</requiredModule>
							</parameter-->
							<model>${basedir}/model/datatypes.fidl</model>
							<outputPath>${basedir}/src/test/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>radioProxyAndProvider</id>
						<phase>generate-test-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>${basedir}/model/radio.fidl</model>
							<outputPath>${basedir}/src/test/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>testProxyAndProvider</id>
						<phase>generate-test-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>Test.fidl</model>
							<outputPath>${basedir}/src/test/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>testTypes</id>
						<phase>generate-test-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>TestTypes.fidl</model>
							<outputPath>${basedir}/src/test/generated</outputPath>
						</configuration>
					</execution>
					<execution>
						<id>generate-franca-name-test-model</id>
						<phase>generate-test-sources</phase>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<model>FrancaNameTest.fidl</model>
							<outputPath>${basedir}/src/test/generated</outputPath>
						</configuration>
					</execution>
				</executions>
				<dependencies>
					<dependency>
						<groupId>io.joynr.tools.generator</groupId>
						<artifactId>js-generator</artifactId>
						<version>${project.version}</version>
					</dependency>
					<dependency>
						<groupId>io.joynr</groupId>
						<artifactId>basemodel</artifactId>
						<version>${project.version}</version>
					</dependency>
					<dependency>
						<groupId>io.joynr</groupId>
						<artifactId>basemodel</artifactId>
						<version>${project.version}</version>
						<type>test-jar</type>
					</dependency>
				</dependencies>
			</plugin>

			<!-- Maven eclipse plugin for better eclipse integration -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-eclipse-plugin</artifactId>
				<configuration>
					<additionalProjectnatures>
						<projectnature>org.eclipse.wst.jsdt.core.jsNature</projectnature>
					</additionalProjectnatures>
				</configuration>
			</plugin>

			<!-- Unpack JavaScript dependencies -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-dependency-plugin</artifactId>
				<configuration>
					<artifactItems>
						<artifactItem>
							<groupId>io.joynr.tools</groupId>
							<artifactId>build-resources</artifactId>
							<version>${project.version}</version>
							<outputDirectory>${project.build.directory}/build-resources</outputDirectory>
							<includes>js-formatter/code-formatter-config.xml</includes>
						</artifactItem>
					</artifactItems>
				</configuration>
				<executions>
					<execution>
						<id>unpack-public-js-source-dependencies</id>
						<goals>
							<goal>unpack</goal>
						</goals>
						<phase>generate-sources</phase>
						<configuration>
							<artifactItems>
								<artifactItem>
									<groupId>io.joynr.javascript</groupId>
									<artifactId>js-dependencies</artifactId>
									<version>${project.version}</version>
									<type>jar</type>
									<outputDirectory>${project.build.directory}/dependencies/</outputDirectory>
									<includes>JsonParser/JsonParser.js,uuid/uuid-annotated.js,log4javascript/log4javascript_uncompressed.js</includes>
								</artifactItem>
								<artifactItem>
									<groupId>io.joynr.tools</groupId>
									<artifactId>build-resources</artifactId>
									<version>${project.version}</version>
									<outputDirectory>${project.build.directory}/build-resources</outputDirectory>
									<includes>js-formatter/code-formatter-config.xml,
											  almond/almond-0.2.5.js</includes>
								</artifactItem>
								<artifactItem>
									<groupId>org.atmosphere.client</groupId>
									<artifactId>javascript</artifactId>
									<version>${atmosphere.javascript.version}</version>
									<type>war</type>
									<outputDirectory>${project.build.directory}/dependencies/atmosphere</outputDirectory>
									<includes>javascript/*.js</includes>
								</artifactItem>
								<artifactItem>
									<groupId>org.webjars</groupId>
									<artifactId>log4javascript</artifactId>
									<version>${log4javascript.version}</version>
									<type>jar</type>
									<outputDirectory>${project.build.directory}/dependencies/log4javascript</outputDirectory>
									<includes>META-INF/resources/webjars/log4javascript/${log4javascript.version}/log4javascript.js</includes>
								</artifactItem>
								<artifactItem>
									<groupId>org.webjars</groupId>
									<artifactId>bluebird</artifactId>
									<version>${bluebird.version}</version>
									<type>jar</type>
									<outputDirectory>${project.build.directory}/dependencies/bluebird</outputDirectory>
									<includes>META-INF/resources/webjars/bluebird/${bluebird.version}/bluebird.js</includes>
								</artifactItem>
								<artifactItem>
									<groupId>org.webjars.npm</groupId>
									<artifactId>text-encoding</artifactId>
									<version>${text-encoding.version}</version>
									<outputDirectory>${project.build.directory}/dependencies/text-encoding</outputDirectory>
									<includes>META-INF/resources/webjars/text-encoding/${text-encoding.version}/lib/encoding.js</includes>
                                </artifactItem>
							</artifactItems>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<!--
			  Since the configuration of the maven-java-formatter-plugin is changed
			  in the plugin management section, we need to add the plugin again in the
			  plugin section, even it is already configured in the super POM. Otherwise
			  the configuration is not set correctly on sub modules.
			-->
			<plugin>
				<groupId>com.marvinformatics.formatter</groupId>
				<artifactId>formatter-maven-plugin</artifactId>
			</plugin>

			<!-- jslint-ing src/main/js -->
			<plugin>
				<groupId>com.googlecode.jslint4java</groupId>
				<artifactId>jslint4java-maven-plugin</artifactId>
				<executions>
					<execution>
						<id>lint-project</id>
						<phase>process-sources</phase>
					</execution>
				</executions>
			</plugin>
			<!-- Copy over dependencies to lib -->
			<plugin>
				<artifactId>maven-resources-plugin</artifactId>
				<version>2.6</version>
				<executions>
					<execution>
						<id>copy-source-dependencies</id>
						<phase>process-sources</phase>
						<goals>
							<goal>copy-resources</goal>
						</goals>
						<configuration>
							<outputDirectory>${project.build.directory}/classes/lib/</outputDirectory>
							<resources>
								<resource>
									<directory>${project.build.directory}/dependencies/atmosphere/javascript/</directory>
									<includes>
										<include>atmosphere.js</include>
										<include>atmosphere-min.js</include>
									</includes>
								</resource>
								<resource>
									<directory>${project.build.directory}/dependencies/log4javascript/META-INF/resources/webjars/log4javascript/${log4javascript.version}/</directory>
									<includes>
										<include>log4javascript.js</include>
									</includes>
								</resource>
								<resource>
									<directory>${project.build.directory}/dependencies/bluebird/META-INF/resources/webjars/bluebird/${bluebird.version}/</directory>
									<includes>
										<include>bluebird.js</include>
									</includes>
								</resource>
								<resource>
									<directory>${project.build.directory}/dependencies/text-encoding/META-INF/resources/webjars/text-encoding/${text-encoding.version}/lib/</directory>
									<includes>
										<include>encoding.js</include>
									</includes>
								</resource>
								<resource>
									<directory>${project.build.directory}/dependencies/JsonParser/</directory>
									<includes>
										<include>JsonParser.js</include>
									</includes>
								</resource>
								<resource>
									<directory>${project.build.directory}/dependencies/uuid/</directory>
									<includes>
										<include>uuid-annotated.js</include>
									</includes>
								</resource>
								<resource>
									<directory>${project.build.directory}/dependencies/log4javascript/</directory>
									<includes>
										<include>log4javascript_uncompressed.js</include>
									</includes>
								</resource>
							</resources>
						</configuration>
					</execution>
					<execution>
						<id>prepare-jar-classes</id>
						<phase>prepare-package</phase>
						<goals>
							<goal>copy-resources</goal>
						</goals>
						<configuration>
							<outputDirectory>${project.build.directory}/jar-classes</outputDirectory>
							<resources>
								<resource>
									<directory>${project.build.directory}/classes</directory>
									<includes>
										<include>JoynrBuildSignature.js</include>
										<include>DISCLAIMER</include>
										<include>META-INF/**</include>
									</includes>
								</resource>
							</resources>
						</configuration>
					</execution>
					<execution>
						<id>prepare-node-classes</id>
						<phase>process-classes</phase>
						<goals>
							<goal>copy-resources</goal>
						</goals>
						<configuration>
							<outputDirectory>${project.build.directory}/node-classes</outputDirectory>
							<resources>
								<resource>
									<directory>${project.build.directory}/classes</directory>
									<includes>
										<include>DISCLAIMER</include>
										<include>joynr.js</include>
										<include>libjoynr-deps*.js</include>
										<include>require.config.node.js</include>
										<include>joynr/**</include>
										<include>global/LocalStorageNode.js</include>
										<include>global/LocalStorage.js</include>
										<include>global/Mqtt.js</include>
										<include>global/Promise.js</include>
										<include>global/SmrfNode.js</include>
										<include>global/WebSocketNode.js</include>
										<include>global/WebSocket.js</include>
										<include>global/XMLHttpRequestNode.js</include>
										<include>global/XMLHttpRequest.js</include>
										<include>lib/atmosphereNode.js</include>
										<include>lib/JsonParser.js</include>
										<include>lib/log4javascriptNode.js</include>
										<include>lib/uuid-annotated.js</include>
										<include>META-INF/**</include>
									</includes>
									<excludes>
										<exclude>joynr/security/PlatformSecurityManager.js</exclude>
										<exclude>joynr/system/ConsoleAppender.js</exclude>
									</excludes>
								</resource>
								<resource>
									<directory>${basedir}/wiki/npm</directory>
								</resource>
								<resource>
									<directory>${basedir}</directory>
									<includes>
										<include>package.json</include>
									</includes>
								</resource>
							</resources>
						</configuration>
					</execution>
				</executions>
			</plugin>

			<!-- Configure packaging of production version matter libjoynr-js -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-jar-plugin</artifactId>
				<configuration>
					<classesDirectory>${project.build.directory}/jar-classes</classesDirectory>
				</configuration>
			</plugin>

			<plugin>
				<groupId>com.phasebash.jsdoc</groupId>
				<artifactId>jsdoc3-maven-plugin</artifactId>
				<version>1.2.0</version>
				<inherited>false</inherited>
				<executions>
					<execution>
						<goals>
							<goal>jsdoc3</goal>
						</goals>
						<phase>install</phase>
					</execution>
				</executions>
				<configuration>
					<directoryRoots>
						<directoryRoot>src/main/js</directoryRoot>
						<directoryRoot>src/main/generated</directoryRoot>
					</directoryRoots>
					<recursive>true</recursive>
					<outputDirectory>${project.build.directory}/jsdoc</outputDirectory>
					<includePrivate>false</includePrivate>
					<configFile>jsdoc3.conf.json</configFile>
				</configuration>
			</plugin>
			<!-- NOTE the license to be added to the source header files must be
				specifically (redundantly) defined below -->
			<!-- This is a shortcoming of the license-maven-plugin -->
			<plugin>
				<groupId>org.codehaus.mojo</groupId>
				<artifactId>license-maven-plugin</artifactId>
				<configuration>
					<verbose>false</verbose>
					<addSvnKeyWords>true</addSvnKeyWords>
					<licenseName>apache_v2</licenseName>
					<roots>
						<root>.</root>
					</roots>
					<excludes>
						<!-- libjoynrEndFrag.js is the end fragment which surrounds the
						     result of the almond optimizer. Its counter part,
						     libjoynrStartFrag.js, already contains the joynr compatible
						     file header
						-->
						<exclude>jsdoc3.conf.json</exclude>
						<exclude>src/main/resources/libjoynrEndFrag.js</exclude>
						<exclude>package.json</exclude>
						<exclude>src/test/resources/node/shutdown/package.json</exclude>
						<exclude>src/test/resources/spec/support/jasmine.json</exclude>
					</excludes>
				</configuration>
			</plugin>

			<plugin>
				<groupId>org.codehaus.mojo</groupId>
				<artifactId>exec-maven-plugin</artifactId>
				<executions>
					<execution>
						<configuration>
							<executable>${project.build.directory}/node-classes/node_modules/.bin/browserify</executable>
							<arguments>
								<argument>${project.build.directory}/node-classes/joynr.js</argument>
								<argument>-u</argument>
								<argument>smrf-native-cpp.node</argument>
								<argument>-u</argument>
								<argument>wscpp-client.node</argument>
								<argument>-u</argument>
								<argument>utf-8-validate</argument>
								<argument>-u</argument>
								<argument>node-persist</argument>
								<argument>-u</argument>
								<argument>bufferutil</argument>
								<argument>-r</argument>
								<argument>${project.build.directory}/node-classes/joynr.js:joynr</argument>
								<argument>-r</argument>
								<argument>./joynr/Runtime.inprocess.js:./joynr/Runtime</argument>
								<argument>-o</argument>
								<argument>${project.build.directory}/jar-classes/joynr.js</argument>
							</arguments>
							<environmentVariables>
								<NODE_PATH>
									${project.build.directory}/node-classes/node_modules
								</NODE_PATH>
							</environmentVariables>
							<workingDirectory>${project.build.directory}/node-classes</workingDirectory>
						</configuration>
						<id>generate-libjoynr-js</id>
						<phase>prepare-package</phase>
						<goals>
							<goal>exec</goal>
						</goals>
					</execution>

					<execution>
						<configuration>
							<executable>${project.build.directory}/node-classes/node_modules/.bin/browserify</executable>
							<arguments>
								<argument>${project.build.directory}/node-classes/joynr.js</argument>
								<argument>-u</argument>
								<argument>smrf-native-cpp.node</argument>
								<argument>-u</argument>
								<argument>wscpp-client.node</argument>
								<argument>-u</argument>
								<argument>utf-8-validate</argument>
								<argument>-u</argument>
								<argument>node-persist</argument>
								<argument>-u</argument>
								<argument>bufferutil</argument>
								<argument>-r</argument>
								<argument>${project.build.directory}/node-classes/joynr.js:joynr</argument>
								<argument>-r</argument>
								<argument>./joynr/Runtime.intertab.clustercontroller.js:./joynr/Runtime</argument>
								<argument>-r</argument>
								<argument>./libjoynr-deps.intertab.clustercontroller.js:./libjoynr-deps</argument>
								<argument>-o</argument>
								<argument>${project.build.directory}/jar-classes/joynr.intertab.clustercontroller.js</argument>
							</arguments>
							<environmentVariables>
								<NODE_PATH>
									${project.build.directory}/node-classes/node_modules
								</NODE_PATH>
							</environmentVariables>
							<workingDirectory>${project.build.directory}/node-classes</workingDirectory>
						</configuration>
						<id>generate-libjoynr-intertab-clustercontroller-js</id>
						<phase>prepare-package</phase>
						<goals>
							<goal>exec</goal>
						</goals>
					</execution>

					<execution>
						<configuration>
							<executable>${project.build.directory}/node-classes/node_modules/.bin/browserify</executable>
							<arguments>
								<argument>${project.build.directory}/node-classes/joynr.js</argument>
								<argument>-u</argument>
								<argument>smrf-native-cpp.node</argument>
								<argument>-u</argument>
								<argument>wscpp-client.node</argument>
								<argument>-u</argument>
								<argument>bufferutil</argument>
								<argument>-u</argument>
								<argument>utf-8-validate</argument>
								<argument>-u</argument>
								<argument>node-persist</argument>
								<argument>-r</argument>
								<argument>${project.build.directory}/node-classes/joynr.js:joynr</argument>
								<argument>-r</argument>
								<argument>./joynr/Runtime.intertab.libjoynr.js:./joynr/Runtime</argument>
								<argument>-o</argument>
								<argument>${project.build.directory}/jar-classes/joynr.intertab.libjoynr.js</argument>
							</arguments>
							<environmentVariables>
								<NODE_PATH>
									${project.build.directory}/node-classes/node_modules
								</NODE_PATH>
							</environmentVariables>
							<workingDirectory>${project.build.directory}/node-classes</workingDirectory>
						</configuration>
						<id>generate-libjoynr-intertab-libjoynr-js</id>
						<phase>prepare-package</phase>
						<goals>
							<goal>exec</goal>
						</goals>
					</execution>

					<execution>
						<configuration>
							<executable>${project.build.directory}/node-classes/node_modules/.bin/browserify</executable>
							<arguments>
								<argument>${project.build.directory}/node-classes/joynr.js</argument>
								<argument>-u</argument>
								<argument>smrf-native-cpp.node</argument>
								<argument>-u</argument>
								<argument>wscpp-client.node</argument>
								<argument>-u</argument>
								<argument>utf-8-validate</argument>
								<argument>-u</argument>
								<argument>node-persist</argument>
								<argument>-u</argument>
								<argument>bufferutil</argument>
								<argument>-r</argument>
								<argument>${project.build.directory}/node-classes/joynr.js:joynr</argument>
								<argument>-r</argument>
								<argument>./joynr/Runtime.websocket.libjoynr.js:./joynr/Runtime</argument>
								<argument>-o</argument>
								<argument>${project.build.directory}/jar-classes/joynr.websocket.libjoynr.js</argument>
							</arguments>
							<environmentVariables>
								<NODE_PATH>
									${project.build.directory}/node-classes/node_modules
								</NODE_PATH>
							</environmentVariables>
							<workingDirectory>${project.build.directory}/node-classes</workingDirectory>
						</configuration>
						<id>generate-libjoynr-websocket-libjoynr-js</id>
						<phase>prepare-package</phase>
						<goals>
							<goal>exec</goal>
						</goals>
					</execution>
				</executions>
			</plugin>
		</plugins>

		<pluginManagement>
			<plugins>
				<!--This plugin's configuration is used to store Eclipse m2e settings only.
					It has no influence on the Maven build itself.-->
				<plugin>
					<groupId>org.eclipse.m2e</groupId>
					<artifactId>lifecycle-mapping</artifactId>
					<version>1.0.0</version>
					<configuration>
						<lifecycleMappingMetadata>
							<pluginExecutions>
								<pluginExecution>
									<pluginExecutionFilter>
										<groupId>
											com.github.skwakman.nodejs-maven-plugin
										</groupId>
										<artifactId>
											nodejs-maven-plugin
										</artifactId>
										<versionRange>
											[1.0.2,)
										</versionRange>
										<goals>
											<goal>extract</goal>
										</goals>
									</pluginExecutionFilter>
									<action>
										<ignore></ignore>
									</action>
								</pluginExecution>
								<pluginExecution>
									<pluginExecutionFilter>
										<groupId>
											org.codehaus.mojo
										</groupId>
										<artifactId>
											exec-maven-plugin
										</artifactId>
										<versionRange>
											[1.3.1,)
										</versionRange>
										<goals>
											<goal>exec</goal>
										</goals>
									</pluginExecutionFilter>
									<action>
										<ignore></ignore>
									</action>
								</pluginExecution>
								<pluginExecution>
									<pluginExecutionFilter>
										<groupId>
											com.marvinformatics.formatter
										</groupId>
										<artifactId>
											formatter-maven-plugin
										</artifactId>
										<versionRange>
											[1.4.0,)
										</versionRange>
										<goals>
											<goal>format</goal>
										</goals>
									</pluginExecutionFilter>
									<action>
										<ignore></ignore>
									</action>
								</pluginExecution>
							</pluginExecutions>
						</lifecycleMappingMetadata>
					</configuration>
				</plugin>
			</plugins>
		</pluginManagement>
	</build>
	<profiles>
		<profile>
			<id>my-test-plugins</id>

			<activation>
				<property>
					<name>skipTests</name>
					<value>false</value>
				</property>
			</activation>
			<build>
				<plugins>
					<!-- Unpack JavaScript dependencies -->
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-dependency-plugin</artifactId>
						<executions>
							<execution>
								<id>copy-backend-wars</id>
								<phase>initialize</phase>
								<goals>
									<goal>copy</goal>
								</goals>
								<configuration>
									<artifactItems>
										<artifactItem>
											<groupId>io.joynr.java.messaging.bounceproxy</groupId>
											<artifactId>single-bounceproxy</artifactId>
											<version>${project.version}</version>
											<type>war</type>
											<outputDirectory>${project.build.directory}</outputDirectory>
											<destFileName>bounceproxy.war</destFileName>
										</artifactItem>
										<artifactItem>
											<groupId>io.joynr.java.backend-services</groupId>
											<artifactId>domain-access-controller-servlet</artifactId>
											<version>${project.version}</version>
											<type>war</type>
											<outputDirectory>${project.build.directory}</outputDirectory>
											<destFileName>accesscontrol.war</destFileName>
										</artifactItem>
										<artifactItem>
											<groupId>io.joynr.java.backend-services</groupId>
											<artifactId>discovery-directory-servlet</artifactId>
											<version>${project.version}</version>
											<type>war</type>
											<outputDirectory>${project.build.directory}</outputDirectory>
											<destFileName>discovery.war</destFileName>
										</artifactItem>
									</artifactItems>
									<overWriteReleases>false</overWriteReleases>
									<overWriteSnapshots>true</overWriteSnapshots>
								</configuration>
							</execution>
						</executions>
					</plugin>
					<!-- jetty only needs to run in case of test execution -->
					<!--
					<plugin>
						<groupId>org.eclipse.jetty</groupId>
						<artifactId>jetty-maven-plugin</artifactId>
						<version>${jetty.version}</version>
						<executions>
							<execution>
								<id>start-jetty</id>
								<phase>pre-integration-test</phase>
								<goals>
									<goal>deploy-war</goal>
								</goals>
								<configuration>
									<daemon>true</daemon>
								</configuration>
							</execution>
							<execution>
								<id>stop-jetty</id>
								<phase>post-integration-test</phase>
								<goals>
									<goal>stop</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
					-->

					<!-- run the tests -->
					<!-- do the "npm install" to get karma and dependencies -->
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<!-- configuration options documentation:
							http://mojo.codehaus.org/exec-maven-plugin/exec-mojo.html -->
						<executions>
							<execution>
								<id>npm-install</id>
								<phase>generate-test-resources</phase>
								<configuration>
									<executable>npm</executable>
									<arguments>
										<argument>install</argument>
										<argument>--ignore-scripts</argument>
									</arguments>
									<workingDirectory>${project.build.directory}/node-classes</workingDirectory>
								</configuration>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>

							<!-- run nodejs based unit tests -->

							<!-- maven doesn't keep the execution permission of
								${project.build.testOutputDirectory}/node_run_unit_tests.sh.
								So we fix it here -->
							<execution>
								<configuration>
									<executable>chmod</executable>
									<commandlineArgs>+x ${project.build.testOutputDirectory}/node_run_unit_tests.sh</commandlineArgs>
								</configuration>
								<id>process-unit-tests-nodejs</id>
								<phase>process-test-classes</phase>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
							<execution>
								<configuration>
									<executable>${project.build.testOutputDirectory}/node_run_unit_tests.sh</executable>
									<commandlineArgs>node-run-unit-tests.js --captureExceptions --verbose</commandlineArgs>
									<environmentVariables>
										<LD_LIBRARY_PATH>
											/usr/lib
										</LD_LIBRARY_PATH>
									</environmentVariables>
								</configuration>
								<id>run-unit-tests-nodejs</id>
								<phase>test</phase>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>

							<!-- run nodejs based integration tests -->

							<!-- maven doesn't keep the execution permission of
								${project.build.testOutputDirectory}/node/shutdown/node_run_shutdown_test.sh.
								So we fix it here -->
							<execution>
								<configuration>
									<executable>chmod</executable>
									<commandlineArgs>+x ${project.build.testOutputDirectory}/node/shutdown/node_run_shutdown_test.sh</commandlineArgs>
								</configuration>
								<id>process-integration-tests-nodejs</id>
								<phase>process-test-classes</phase>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
							<execution>
								<configuration>
									<executable>${project.build.testOutputDirectory}/node/shutdown/node_run_shutdown_test.sh</executable>
									<commandlineArgs>--captureExceptions --verbose</commandlineArgs>
								</configuration>
								<id>run-integration-tests-nodejs</id>
								<phase>integration-test</phase>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
					</plugin>

					<!-- run karma -->
					<plugin>
						<groupId>com.kelveden</groupId>
						<artifactId>maven-karma-plugin</artifactId>
						<version>1.8</version>
						<executions>
							<execution>
								<phase>integration-test</phase>
								<id>karma-integration-tests</id>
								<goals>
									<goal>start</goal>
								</goals>
								<configuration>
									<configFile>${basedir}/src/test/karma/karma.integration.conf.js</configFile>
								</configuration>
							</execution>
							<!-- Disabled since there is no SMRF support inside browser required by end2end tests
							<execution>
								<phase>integration-test</phase>
								<id>karma-system-integration-tests</id>
								<goals>
									<goal>start</goal>
								</goals>
								<configuration>
									<configFile>${basedir}/src/test/karma/karma.system.integration.conf.js</configFile>
								</configuration>
							</execution>
							-->
							<execution>
								<phase>integration-test</phase>
								<id>karma-intertab-integration-tests</id>
								<goals>
									<goal>start</goal>
								</goals>
								<configuration>
									<configFile>${basedir}/src/test/karma/karma.intertab.integration.conf.js</configFile>
								</configuration>
							</execution>
						</executions>
						<configuration>
							<karmaExecutable>${project.build.directory}/node-classes/node_modules/.bin/karma</karmaExecutable>
							<skipKarma>false</skipKarma>
							<karmaFailureIgnore>false</karmaFailureIgnore>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>create-mqtt-module</id>
			<activation>
				<property>
					<name>!skipMqttModuleCreation</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<!-- configuration options documentation:
							http://mojo.codehaus.org/exec-maven-plugin/exec-mojo.html -->
						<executions>
							<execution>
								<id>npm-install</id>
								<phase>generate-test-resources</phase>
								<configuration>
									<executable>npm</executable>
									<arguments>
										<argument>install</argument>
									</arguments>
									<workingDirectory>${project.build.directory}/node-classes</workingDirectory>
								</configuration>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
							<execution>
								<id>install browserify</id>
								<phase>process-sources</phase>
								<configuration>
									<executable>npm</executable>
									<arguments>
										<argument>install</argument>
										<argument>--prefix=${project.build.directory}/node-classes</argument>
										<argument>browserify@13.3.0</argument>
									</arguments>
								</configuration>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
							<execution>
								<id>install mqtt</id>
								<phase>process-sources</phase>
								<configuration>
									<executable>npm</executable>
									<arguments>
										<argument>install</argument>
										<argument>mqtt@${mqtt.version}</argument>
										<argument>--prefix=${project.build.directory}/node-classes</argument>
									</arguments>
								</configuration>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
							<execution>
								<id>browserify mqtt</id>
								<phase>process-sources</phase>
								<configuration>
									<executable>./cmd.js</executable>
									<arguments>
										<argument>${project.build.directory}/node-classes/node_modules/mqtt/mqtt.js</argument>
										<argument>-s</argument>
										<argument>mqtt</argument>
										<argument>-o</argument>
										<argument>${project.build.directory}/classes/lib/mqtt.js</argument>
									</arguments>
									<workingDirectory>${project.build.directory}/node-classes/node_modules/browserify/bin</workingDirectory>
								</configuration>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>
</project>
